<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Dashboard</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; padding: 18px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: flex-end; }
    .card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 14px; }
    .grow { flex: 1 1 auto; }
    label { display: block; font-size: 13px; margin-bottom: 6px; }
    select, input { padding: 10px; width: 100%; box-sizing: border-box; }
    button { padding: 10px 12px; cursor: pointer; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid #e5e7eb; padding: 8px; text-align: left; font-size: 13px; }
    th { background: #f9fafb; position: sticky; top: 0; }
    .muted { color: #6b7280; font-size: 13px; }
    .pill { display: inline-block; padding: 3px 8px; border-radius: 999px; border: 1px solid #e5e7eb; font-size: 12px; }
    .actions { display: flex; gap: 8px; flex-wrap: wrap; }
    .danger { background: #dc2626; color: white; border: 0; border-radius: 10px; }
    .danger:disabled { opacity: 0.65; cursor: not-allowed; }
    .preview { border: 1px dashed #e5e7eb; border-radius: 12px; padding: 10px; }
    a { color: inherit; }
  </style>
</head>
<body>
  <div class="row" style="justify-content: space-between;">
    <div>
      <h2 style="margin: 0;">Admin Dashboard</h2>
      <div class="muted">Live updates every 5 seconds · <span id="serverTime">-</span></div>
    </div>
    <form method="post" action="/admin/logout">
      <button type="submit">Logout</button>
    </form>
  </div>

  <div class="row" style="margin-top: 12px;">
    <div class="card grow" style="min-width: 300px;">
      <label for="eventSelect">Selected event</label>
      <select id="eventSelect">
        {% for e in events %}
          <option value="{{ e.event_id }}" {% if e.event_id == selected_event_id %}selected{% endif %}>
            #{{ e.event_id }} · {{ e.event_name }}{% if e.is_active %} (active){% endif %}
          </option>
        {% endfor %}
      </select>

      <div class="muted" style="margin-top: 8px;">
        Scanning is using: <b id="scanningEvent">-</b> · <b id="scanningSession">-</b>
      </div>

      <div style="margin-top: 10px;">
        <label for="sessionSelect">Selected session</label>
        <select id="sessionSelect">
          {% for s in sessions %}
            <option value="{{ s.session_id }}" {% if active_session and s.session_id == active_session.session_id %}selected{% endif %}>
              #{{ s.session_id }} · {{ s.session_name }}{% if s.is_active %} (open){% endif %}
            </option>
          {% endfor %}
        </select>
        <div class="muted" style="margin-top: 6px;">Selecting a session is view-only; scans always go to the open session. Creating a new session resets attendance.</div>
      </div>

      <div class="actions" style="margin-top: 10px;">
        <a id="downloadAll" href="#" class="pill">Download Full List</a>
        <a id="downloadPresent" href="#" class="pill">Download Present Only</a>
      </div>

      <div class="actions" style="margin-top: 10px;">
        <form method="post" action="/admin/events/{{ selected_event_id }}/sessions/create" class="row" style="gap: 8px; margin: 0; flex: 1 1 auto; align-items: flex-end;">
          <div style="flex: 1 1 220px;">
            <label>New session name</label>
            <input name="session_name" placeholder="e.g. Session 2" />
          </div>
          <div style="flex: 0 0 auto;">
            <label>&nbsp;</label>
            <button type="submit">Create & Open Session</button>
          </div>
        </form>
      </div>

      <div class="actions" style="margin-top: 10px; align-items: center;">
        <input id="importFile" type="file" accept=".xlsx" style="display:none" />
        <button id="importBtn" type="button" class="danger">Import Excel Sheet</button>
        <span id="importStatus" class="muted"></span>
      </div>
      <div class="muted" style="margin-top: 8px;">Excel columns: UID, Name, Branch, Year</div>

      <div id="importPreviewWrap" class="preview" style="margin-top: 10px; display:none;">
        <div class="row" style="align-items: center; justify-content: space-between;">
          <b>Confirm import</b>
          <button id="confirmImportBtn" type="button">Confirm & Import</button>
        </div>
        <div class="muted" style="margin-top: 6px;">Students in the selected Excel sheet: <b id="importCount">0</b></div>
        <div style="max-height: 220px; overflow: auto; margin-top: 10px;">
          <table>
            <thead>
              <tr>
                <th>UID</th>
                <th>Name</th>
                <th>Branch</th>
                <th>Year</th>
              </tr>
            </thead>
            <tbody id="importPreviewBody"></tbody>
          </table>
        </div>
      </div>

      <div class="actions" style="margin-top: 10px;">
        <form id="closeForm" method="post" style="margin: 0;"></form>
        <form id="openForm" method="post" style="margin: 0;"></form>
        <button id="closeBtn" type="button">Close event</button>
        <button id="openBtn" type="button">Open event</button>
      </div>
    </div>

    <div class="card" style="min-width: 260px;">
      <div><span class="pill">Total</span> <b id="total">-</b></div>
      <div style="margin-top: 6px;"><span class="pill">Present</span> <b id="present">-</b></div>
      <div style="margin-top: 6px;"><span class="pill">Remaining</span> <b id="remaining">-</b></div>
      <div style="margin-top: 6px;"><span class="pill">Total scanned</span> <b id="totalScanned">-</b></div>
    </div>

    <div class="card grow" style="min-width: 280px;">
      <b>Device-wise stats</b>
      <div id="deviceStats" class="muted" style="margin-top: 8px;">-</div>
    </div>
  </div>

  <div class="card" style="margin-top: 12px;">
    <b>Live attendance</b>
    <div class="muted" style="margin-top: 6px;">Showing only marked attendance (no pre-event roster).</div>

    <div style="max-height: 60vh; overflow: auto; margin-top: 10px;">
      <table>
        <thead>
          <tr>
            <th>UID</th>
            <th>Name</th>
            <th>Branch</th>
            <th>Year</th>
            <th>Status</th>
            <th>Time</th>
            <th>Source</th>
            <th>Device</th>
          </tr>
        </thead>
        <tbody id="attendanceBody">
          <tr><td colspan="8" class="muted">Loading…</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="card" style="margin-top: 12px;">
    <b>Create event</b>
    <form method="post" action="/admin/events/create" class="row" style="margin-top: 10px;">
      <div style="flex: 2 1 220px;">
        <label>Event name</label>
        <input name="event_name" required />
      </div>
      <div style="flex: 1 1 160px;">
        <label>Start time</label>
        <input name="start_time" placeholder="optional" />
      </div>
      <div style="flex: 1 1 160px;">
        <label>End time</label>
        <input name="end_time" placeholder="optional" />
      </div>
      <div style="flex: 0 1 180px;">
        <label>Set active</label>
        <select name="is_active">
          <option value="1">Yes</option>
          <option value="0" selected>No</option>
        </select>
      </div>
      <div style="flex: 0 1 auto;">
        <button type="submit">Create</button>
      </div>
    </form>
    <div class="muted" style="margin-top: 8px;">Tip: Keep only the current event active for faster device selection.</div>
  </div>

  <script>
    const POLL_MS = 5000;

    const eventSelect = document.getElementById('eventSelect');
    const sessionSelect = document.getElementById('sessionSelect');
    const serverTime = document.getElementById('serverTime');
    const scanningEvent = document.getElementById('scanningEvent');
    const scanningSession = document.getElementById('scanningSession');

    const totalEl = document.getElementById('total');
    const presentEl = document.getElementById('present');
    const remainingEl = document.getElementById('remaining');
    const totalScannedEl = document.getElementById('totalScanned');

    const deviceStatsEl = document.getElementById('deviceStats');
    const attendanceBody = document.getElementById('attendanceBody');

    const downloadAll = document.getElementById('downloadAll');
    const downloadPresent = document.getElementById('downloadPresent');

    const importBtn = document.getElementById('importBtn');
    const importFile = document.getElementById('importFile');
    const importStatus = document.getElementById('importStatus');
    const importPreviewWrap = document.getElementById('importPreviewWrap');
    const importPreviewBody = document.getElementById('importPreviewBody');
    const importCount = document.getElementById('importCount');
    const confirmImportBtn = document.getElementById('confirmImportBtn');

    let pendingImportToken = '';

    const closeBtn = document.getElementById('closeBtn');
    const openBtn = document.getElementById('openBtn');

    function currentEventId() {
      return eventSelect.value;
    }

    function currentSessionId() {
      return sessionSelect ? sessionSelect.value : '';
    }

    async function refreshSessions() {
      const eid = currentEventId();
      if (!sessionSelect) return;
      const previouslySelected = currentSessionId();
      const res = await fetch(`/admin/api/sessions?event_id=${encodeURIComponent(eid)}`, { cache: 'no-store' });
      if (!res.ok) return;
      const data = await res.json();
      const sessions = data.sessions || [];
      const active = data.active || null;

      sessionSelect.innerHTML = sessions
        .map(s => {
          const open = s.is_active ? ' (open)' : '';
          const selected = previouslySelected
            ? (String(previouslySelected) === String(s.session_id) ? ' selected' : '')
            : (active && String(active.session_id) === String(s.session_id) ? ' selected' : '');
          return `<option value="${escapeHtml(s.session_id)}"${selected}>#${escapeHtml(s.session_id)} · ${escapeHtml(s.session_name)}${open}</option>`;
        })
        .join('');

      updateLinksAndActions();

      updateLinksAndActions();
    }

    async function refreshScanningState() {
      try {
        const er = await fetch('/events?active=1', { cache: 'no-store' });
        if (!er.ok) {
          scanningEvent.textContent = '-';
          scanningSession.textContent = '-';
          return;
        }
        const activeEvents = await er.json().catch(() => []);
        const activeEvent = Array.isArray(activeEvents) && activeEvents.length ? activeEvents[0] : null;
        if (!activeEvent) {
          scanningEvent.textContent = 'No active event';
          scanningSession.textContent = 'No open session';
          return;
        }

        const eid = String(activeEvent.event_id ?? '');
        const name = String(activeEvent.event_name ?? '').trim();
        scanningEvent.textContent = eid ? `#${eid} · ${name || 'Event'}` : (name || 'Event');

        const sr = await fetch(`/admin/api/sessions?event_id=${encodeURIComponent(eid)}`, { cache: 'no-store' });
        if (sr.status === 401) {
          location.href = '/admin/login';
          return;
        }
        if (!sr.ok) {
          scanningSession.textContent = 'No open session';
          return;
        }
        const sdata = await sr.json().catch(() => ({}));
        const active = sdata.active || null;
        if (!active) {
          scanningSession.textContent = 'No open session';
          return;
        }
        const sid = String(active.session_id ?? '');
        const sname = String(active.session_name ?? '').trim();
        scanningSession.textContent = sid ? `#${sid} · ${sname || 'Session'} (open)` : `${sname || 'Session'} (open)`;
      } catch {
        scanningEvent.textContent = '-';
        scanningSession.textContent = '-';
      }
    }

    function updateLinksAndActions() {
      const eid = currentEventId();
      const sid = currentSessionId();
      const base = new URLSearchParams({ present_only: '0', event_id: String(eid) });
      if (sid) base.set('session_id', String(sid));
      downloadAll.href = `/export?${base.toString()}`;
      base.set('present_only', '1');
      downloadPresent.href = `/export?${base.toString()}`;

      closeBtn.onclick = () => {
        fetch(`/admin/events/${encodeURIComponent(eid)}/close`, { method: 'POST' }).then(() => location.reload());
      };
      openBtn.onclick = () => {
        fetch(`/admin/events/${encodeURIComponent(eid)}/open`, { method: 'POST' }).then(() => location.reload());
      };
    }

    function setImportStatus(text, isError) {
      importStatus.textContent = text || '';
      importStatus.style.color = isError ? '#b91c1c' : '';
    }

    function clearPreview() {
      pendingImportToken = '';
      importPreviewWrap.style.display = 'none';
      importPreviewBody.innerHTML = '';
      importCount.textContent = '0';
      confirmImportBtn.disabled = true;
    }

    function renderImportPreview(rows) {
      if (!Array.isArray(rows) || rows.length === 0) {
        clearPreview();
        setImportStatus('No valid rows found (UID and Name required).', true);
        return;
      }
      importCount.textContent = String(rows.length);
      importPreviewBody.innerHTML = rows.map(r => `
        <tr>
          <td>${escapeHtml(r.uid || '')}</td>
          <td>${escapeHtml(r.name || '')}</td>
          <td>${escapeHtml(r.branch || '')}</td>
          <td>${escapeHtml(r.year || '')}</td>
        </tr>
      `).join('');
      importPreviewWrap.style.display = '';
      confirmImportBtn.disabled = false;
    }

    importBtn.addEventListener('click', () => {
      setImportStatus('', false);
      importFile.value = '';
      clearPreview();
      importFile.click();
    });

    importFile.addEventListener('change', async () => {
      const file = importFile.files && importFile.files[0];
      if (!file) return;

      importBtn.disabled = true;
      setImportStatus('Uploading for preview…', false);

      try {
        const fd = new FormData();
        fd.append('event_id', currentEventId());
        fd.append('file', file);

        const res = await fetch('/admin/api/import/preview', { method: 'POST', body: fd });
        if (res.status === 401) {
          location.href = '/admin/login';
          return;
        }

        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          setImportStatus(data.error || `Import failed (${res.status})`, true);
          return;
        }

        pendingImportToken = data.token || '';
        setImportStatus('Preview loaded. Click “Confirm & Import”.', false);
        renderImportPreview(data.rows || []);
      } catch (e) {
        setImportStatus(`Import failed: ${e}`, true);
      } finally {
        importBtn.disabled = false;
      }
    });

    confirmImportBtn.addEventListener('click', async () => {
      if (!pendingImportToken) {
        setImportStatus('Please upload an Excel file first.', true);
        return;
      }

      confirmImportBtn.disabled = true;
      importBtn.disabled = true;
      setImportStatus('Importing…', false);

      try {
        const fd = new FormData();
        fd.append('event_id', currentEventId());
        fd.append('token', pendingImportToken);

        const res = await fetch('/admin/api/import/confirm', { method: 'POST', body: fd });
        if (res.status === 401) {
          location.href = '/admin/login';
          return;
        }

        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          setImportStatus(data.error || `Import failed (${res.status})`, true);
          return;
        }

        setImportStatus(`Imported ${data.imported ?? 0} students.`, false);
        clearPreview();
        pollOnce();
      } catch (e) {
        setImportStatus(`Import failed: ${e}`, true);
      } finally {
        importBtn.disabled = false;
        confirmImportBtn.disabled = false;
      }
    });

    function escapeHtml(s) {
      return String(s)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    function renderDeviceStats(list) {
      if (!Array.isArray(list) || list.length === 0) {
        deviceStatsEl.textContent = 'No device stats yet.';
        return;
      }
      deviceStatsEl.innerHTML = list
        .map(d => {
          const state = d.online ? 'ONLINE' : 'OFFLINE';
          const lastSeen = d.last_seen || '';
          const ip = d.last_ip || '';
          return `${escapeHtml(d.device_id)} <span class="pill">${escapeHtml(state)}</span> · Present: <b>${escapeHtml(d.present_count)}</b>`
            + (lastSeen ? ` · Last seen: ${escapeHtml(lastSeen)}` : '')
            + (ip ? ` · IP: ${escapeHtml(ip)}` : '');
        })
        .join('<br/>');
    }

    function renderAttendance(rows) {
      if (!Array.isArray(rows) || rows.length === 0) {
        attendanceBody.innerHTML = `<tr><td colspan="8" class="muted">No rows.</td></tr>`;
        return;
      }

      attendanceBody.innerHTML = rows.map(r => {
        const status = (r.status || '').toLowerCase() === 'present' ? 'Present' : 'Absent';
        return `
          <tr>
            <td>${escapeHtml(r.uid)}</td>
            <td>${escapeHtml(r.name)}</td>
            <td>${escapeHtml(r.branch || '')}</td>
            <td>${escapeHtml(r.year || '')}</td>
            <td>${escapeHtml(status)}</td>
            <td>${escapeHtml(r.timestamp || '')}</td>
            <td>${escapeHtml(r.source || '')}</td>
            <td>${escapeHtml(r.device_id || '')}</td>
          </tr>
        `;
      }).join('');
    }

    async function pollOnce() {
      const eid = currentEventId();
      const sid = currentSessionId();
      const qs = new URLSearchParams({ event_id: String(eid) });
      if (sid) qs.set('session_id', String(sid));
      const res = await fetch(`/admin/api/dashboard?${qs.toString()}`, { cache: 'no-store' });
      if (res.status === 401) {
        location.href = '/admin/login';
        return;
      }
      const data = await res.json();

      serverTime.textContent = data.server_time || '-';

      totalEl.textContent = data.summary?.total ?? '-';
      presentEl.textContent = data.summary?.present ?? '-';
      remainingEl.textContent = data.summary?.remaining ?? '-';
      totalScannedEl.textContent = data.summary?.total_scanned ?? '-';

      renderDeviceStats(data.device_stats);
      renderAttendance(data.attendance);
    }

    eventSelect.addEventListener('change', () => {
      updateLinksAndActions();
      refreshSessions();
      refreshScanningState();
      pollOnce();
    });

    if (sessionSelect) {
      sessionSelect.addEventListener('change', () => {
        updateLinksAndActions();
        pollOnce();
      });
    }

    updateLinksAndActions();
    refreshSessions();
    refreshScanningState();
    pollOnce();
    setInterval(pollOnce, POLL_MS);
    setInterval(refreshScanningState, POLL_MS);
  </script>
</body>
</html>
